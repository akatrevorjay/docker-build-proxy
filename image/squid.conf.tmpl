
# this file contains private networks (10.0.0.0/8, 172.16.0.0/12,
# 192.168.0.0/16) by default, you can add/remove additional allowed
# source networks in it to customize it for your setup
#acl allowed_networks src "{{ .Env.CONFIG_DIR }}/autogenerated/allowed-networks-src.acl"

http_port {{ .Env.HTTP_PORT }}

{{if .Env.TRANSPARENT_PORT }}
http_port {{ .Env.TRANSPARENT_PORT }} transparent
{{ end }}

{{ if .Env.SSL_BUMP_PORT }}
http_port {{ .Env.SSL_BUMP_PORT }} ssl-bump cert={{ .Env.SSL_CERT }} key={{ .Env.SSL_KEY }} generate-host-certificates=on

# Allow bumping of the connection. Establish a secure connection with the
# server first, then establish a secure connection with the client, using a
# mimicked server certificate. Works with both CONNECT requests and intercepted
# SSL connections.
#
# http://www.squid-cache.org/Versions/v3/3.4/cfgman/ssl_bump.html
ssl_bump server-first all
{{ end }}

# user visible name
visible_hostname {{ default .Env.VISIBLE_HOSTNAME .Env.HOSTNAME }}
shutdown_lifetime 0

## Logging
cache_access_log {{ .Env.LOG_DIR }}/access.log squid
cache_log {{ .Env.LOG_DIR }}/cache.log
cache_store_log {{ .Env.LOG_DIR }}/store.log
log_mime_hdrs on
strip_query_terms off  # Log query terms

## Client
#request_header_max_size 8 KB
#request_body_max_size 8 KB
#reply_body_max_size 200 MB all
read_ahead_gap 1024 KB
quick_abort_min 0 KB
quick_abort_max 0 KB
quick_abort_pct 100

# we need a big cache, some debs are huge
maximum_object_size 512 MB

# use a different dir than stock squid and default to 40G
cache_dir aufs {{ .Env.CACHE_DIR }} 40000 16 256
cache_replacement_policy heap LFUDA

# tweaks to speed things up
cache_mem {{ .Env.CACHE_MEM }}
maximum_object_size_in_memory {{ .Env.MAX_OBJECT_SIZE_IN_MEMORY }}
# Greedy-Dual Size Frequency
memory_replacement_policy heap GDSF

# pid
#pid_filename /var/run/docker-build-proxy.pid

# refresh pattern for debs and udebs
refresh_pattern deb$   129600 100% 129600
refresh_pattern udeb$   129600 100% 129600
refresh_pattern rpm$  129600 100% 129600

refresh_pattern zip$  129600 100% 129600
refresh_pattern tar.gz$  129600 100% 129600
refresh_pattern tar.xz$  129600 100% 129600
refresh_pattern tar.bz2$  129600 100% 129600

refresh_pattern -i .(exe|tar|tgz|gz|bz2|ram|rar|bin|iso)$ 129600 20% 129600 refresh-ims
#override-expire ignore-no-cache ignore-no-store

# always refresh Packages and Release files
refresh_pattern \/(Packages|Sources)(|\.bz2|\.gz|\.xz)$ 0 20% 4320 refresh-ims
refresh_pattern \/Release(|\.gpg)$ 0 20% 4320 refresh-ims
refresh_pattern \/InRelease$ 0 20% 4320 refresh-ims
refresh_pattern \/(Translation-.*)(|\.bz2|\.gz|\.xz)$ 0 20% 4320 refresh-ims
refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880

# handle meta-release and changelogs.ubuntu.com special
# (fine to have this on debian too)
refresh_pattern changelogs.ubuntu.com\/.*  0  1% 1

# Final refresh for the rest
refresh_pattern .       0   20% 4320 refresh-ims
#refresh_all_ims on

## do not allow to download from the pkg blacklist
#http_access deny blockedpkgs

## allow access from our network and localhost
#http_access allow allowed_networks

## And finally deny all other access to this proxy
#http_access deny all
http_access allow all

# we don't want to clash with the squid3 netdb state file
netdb_filename stdio:{{ .Env.LOG_DIR }}/netdb.state
